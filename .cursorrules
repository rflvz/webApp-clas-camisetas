# Reglas y Contexto del Proyecto - Interfaz Web para Motor de Clustering HDBSCAN

## üéØ Contexto del Proyecto

### Descripci√≥n General
Interfaz web moderna construida con Next.js que proporciona una interfaz sofisticada para configurar y gestionar los par√°metros del motor de clustering HDBSCAN. El proyecto permite a los usuarios configurar clustering de im√°genes de camisetas a trav√©s de tres modos de configuraci√≥n: B√°sico, Avanzado y Super Avanzado.

### Objetivos del Proyecto
- Crear una interfaz web intuitiva para configurar par√°metros HDBSCAN
- Proporcionar tres niveles de complejidad para diferentes tipos de usuarios
- Integrar con motor de clustering existente para procesamiento de im√°genes
- Mantener alta calidad de c√≥digo y documentaci√≥n completa

## üèóÔ∏è Stack Tecnol√≥gico

### Frontend
- **Next.js 14+**: Framework React con App Router
- **TypeScript**: Tipado est√°tico para JavaScript
- **Tailwind CSS**: Framework de utilidades CSS
- **React Hook Form**: Manejo de formularios
- **Zod**: Validaci√≥n de esquemas y datos
- **Lucide React**: Iconograf√≠a moderna

### Backend
- **Next.js API Routes**: Endpoints del servidor
- **PostgreSQL**: Base de datos relacional
- **Prisma**: ORM para base de datos
- **Zod**: Validaci√≥n de datos del servidor

### Desarrollo y Calidad
- **ESLint**: Linting de c√≥digo
- **Prettier**: Formateo de c√≥digo
- **Jest**: Testing unitario
- **Playwright**: Testing end-to-end
- **Husky**: Git hooks
- **Commitlint**: Validaci√≥n de commits

### Deployment
- **Vercel**: Hosting y deployment
- **GitHub Actions**: CI/CD pipeline
- **Docker**: Containerizaci√≥n (opcional)

## üìÅ Estructura del Proyecto

```
app-clas-camisetas/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/                    # Next.js App Router
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx         # Layout principal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx           # P√°gina home
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ globals.css        # Estilos globales
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api/               # API Routes
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ clusters/      # Endpoints de clustering
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ presets/       # Endpoints de presets
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ validation/    # Endpoints de validaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ components/            # Componentes React
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/               # Componentes base (Button, Input, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ forms/            # Componentes de formularios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ editor/           # Componentes del editor
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ layout/           # Componentes de layout
‚îÇ   ‚îú‚îÄ‚îÄ hooks/                # Custom React hooks
‚îÇ   ‚îú‚îÄ‚îÄ lib/                  # Utilidades y configuraciones
‚îÇ   ‚îú‚îÄ‚îÄ types/                # Definiciones de tipos TypeScript
‚îÇ   ‚îú‚îÄ‚îÄ utils/                # Funciones de utilidad
‚îÇ   ‚îî‚îÄ‚îÄ styles/               # Estilos adicionales
‚îú‚îÄ‚îÄ docs/                     # Documentaci√≥n del proyecto
‚îú‚îÄ‚îÄ public/                   # Assets est√°ticos
‚îú‚îÄ‚îÄ prisma/                   # Esquemas y migraciones de BD
‚îú‚îÄ‚îÄ tests/                    # Tests del proyecto
‚îú‚îÄ‚îÄ .github/                  # Templates y workflows
‚îú‚îÄ‚îÄ config.example.yaml       # Configuraci√≥n HDBSCAN de ejemplo
‚îî‚îÄ‚îÄ .cursorrules             # Este archivo
```

## üé® Arquitectura y Patrones

### Arquitectura de Componentes
- **Compound Components**: Para flexibilidad en componentes complejos
- **Render Props**: Para compartir l√≥gica entre componentes
- **Custom Hooks**: Para encapsular l√≥gica de estado compleja
- **Factory Pattern**: Para creaci√≥n de presets
- **Strategy Pattern**: Para diferentes estrategias de validaci√≥n
- **Observer Pattern**: Para actualizaciones en tiempo real

### Tres Modos de Configuraci√≥n
1. **B√°sico**: Presets predefinidos (R√°pido, Balanceado, Preciso)
2. **Avanzado**: Par√°metros principales organizados por categor√≠as
3. **Super Avanzado**: Control total de todos los par√°metros HDBSCAN

### Flujo de Datos
```
User Input ‚Üí Client Validation ‚Üí Server Validation ‚Üí Database
     ‚Üì              ‚Üì                    ‚Üì              ‚Üì
  Real-time     Form Submit        API Response    Persistence
  Feedback      Validation         Validation      
```

## ‚öôÔ∏è Configuraci√≥n HDBSCAN

### Par√°metros Principales (del config.example.yaml)
```yaml
clustering:
  algorithm: "hdbscan"
  min_cluster_size: 6          # Tama√±o m√≠nimo de cluster
  min_samples: 2               # Muestras m√≠nimas
  metric: "euclidean"          # M√©trica de distancia
  cluster_selection_epsilon: 0.0  # Granularidad de clusters
  max_retries: 2               # Reintentos si m√©tricas inaceptables
```

### Par√°metros Avanzados
```yaml
# Agrupaci√≥n jer√°rquica
hierarchical_grouping: true
max_inter_cluster_distance: 0.35

# Re-clustering iterativo
max_reclustering_iterations: 3
target_subcluster_cohesion: 0.90
max_subclusters: 6
max_outlier_ratio: 0.50

# Balanceo inteligente
balanced_clustering: true
balance_min_size: 10
balance_max_size: 30
cohesion_threshold: 0.65
```

### Post-procesamiento
```yaml
post_processing:
  enabled: true
  min_cluster_size: 8
  max_cluster_size: 30
  target_clusters: 6
  merge_strategy: "centroid_distance"
  split_strategy: "kmeans"
```

## üîß Reglas de Desarrollo

### Convenciones de C√≥digo

#### Naming Conventions
- **Componentes**: PascalCase (`ClusterForm.tsx`)
- **Hooks**: camelCase con prefijo `use` (`useClusterParams.ts`)
- **Utilidades**: camelCase (`formatClusterData.ts`)
- **Constantes**: UPPER_SNAKE_CASE (`MAX_CLUSTER_SIZE`)
- **Tipos**: PascalCase (`ClusterParams`, `ValidationResult`)

#### Estructura de Archivos
```typescript
// Orden de imports
import React from 'react';           // React imports
import { NextRequest } from 'next';  // Next.js imports
import { z } from 'zod';            // Third-party imports

import { Button } from '@/components/ui'; // Internal imports
import { validateParams } from '@/utils';  // Utility imports
import type { ClusterParams } from '@/types'; // Type imports
```

#### Componentes React
```typescript
// Estructura est√°ndar de componente
interface ComponentProps {
  // Props tipadas con TypeScript
}

export function Component({ prop1, prop2 }: ComponentProps) {
  // 1. Hooks de estado
  const [state, setState] = useState();
  
  // 2. Custom hooks
  const { data, loading } = useCustomHook();
  
  // 3. Callbacks y handlers
  const handleSubmit = useCallback(() => {
    // L√≥gica del handler
  }, [dependencies]);
  
  // 4. Effects
  useEffect(() => {
    // Side effects
  }, [dependencies]);
  
  // 5. Render
  return (
    <div>
      {/* JSX */}
    </div>
  );
}
```

### Validaci√≥n con Zod
```typescript
// Esquemas de validaci√≥n centralizados
const clusterParamsSchema = z.object({
  min_cluster_size: z.number().min(2).max(1000),
  min_samples: z.number().min(1).max(100),
  metric: z.enum(['euclidean', 'manhattan', 'cosine']),
  cluster_selection_epsilon: z.number().min(0).max(1)
});

// Uso en componentes
const { errors } = useValidation(clusterParamsSchema, formData);

// Uso en API routes
export async function POST(request: Request) {
  const body = await request.json();
  const validParams = clusterParamsSchema.parse(body);
  // ...
}
```

### API Routes
```typescript
// Estructura est√°ndar de API route
export async function GET(request: NextRequest) {
  try {
    // 1. Validaci√≥n de entrada
    const params = validateRequestParams(request);
    
    // 2. L√≥gica de negocio
    const result = await processRequest(params);
    
    // 3. Respuesta exitosa
    return NextResponse.json({
      success: true,
      data: result
    });
  } catch (error) {
    // 4. Manejo de errores
    return NextResponse.json({
      success: false,
      error: {
        code: 'VALIDATION_ERROR',
        message: error.message
      }
    }, { status: 400 });
  }
}
```

## üß™ Testing

### Estructura de Tests
```
tests/
‚îú‚îÄ‚îÄ __mocks__/           # Mocks globales
‚îú‚îÄ‚îÄ components/          # Tests de componentes
‚îú‚îÄ‚îÄ hooks/              # Tests de custom hooks
‚îú‚îÄ‚îÄ utils/              # Tests de utilidades
‚îú‚îÄ‚îÄ api/                # Tests de API routes
‚îî‚îÄ‚îÄ e2e/                # Tests end-to-end
```

### Convenciones de Testing
```typescript
// Tests unitarios con Jest
describe('ClusterForm', () => {
  it('should validate parameters correctly', () => {
    // Arrange
    const params = { min_cluster_size: 5 };
    
    // Act
    const result = validateClusterParams(params);
    
    // Assert
    expect(result.isValid).toBe(true);
  });
});

// Tests de componentes con Testing Library
import { render, screen, fireEvent } from '@testing-library/react';

test('renders cluster form with default values', () => {
  render(<ClusterForm />);
  expect(screen.getByLabelText(/min cluster size/i)).toBeInTheDocument();
});
```

## üöÄ Performance

### Optimizaciones de React
- **Code Splitting**: Lazy loading de componentes pesados
- **Memoizaci√≥n**: `memo`, `useMemo`, `useCallback` para componentes costosos
- **Virtualization**: Para listas grandes de par√°metros

### Optimizaciones de Next.js
- **Static Generation**: Para p√°ginas de presets
- **Image Optimization**: Componente `next/image`
- **Bundle Analysis**: An√°lisis regular del bundle size

## üîí Seguridad

### Validaci√≥n de Entrada
- Sanitizaci√≥n con DOMPurify
- Validaci√≥n estricta con Zod en cliente y servidor
- Rate limiting en API routes

### Headers de Seguridad
```typescript
// next.config.js
const nextConfig = {
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          { key: 'X-Content-Type-Options', value: 'nosniff' },
          { key: 'X-Frame-Options', value: 'DENY' },
          { key: 'X-XSS-Protection', value: '1; mode=block' },
        ],
      },
    ];
  },
};
```

## üåä Git Flow y Branching

### Estrategia de Branching
- **main**: C√≥digo de producci√≥n estable
- **develop**: Branch de integraci√≥n principal
- **feature/DNT-XXX-descripcion**: Features nuevas
- **fix/DNT-XXX-descripcion**: Bug fixes
- **docs/DNT-XXX-descripcion**: Documentaci√≥n

### Convenciones de Commit
```
<tipo>(<scope>): <descripci√≥n corta>

<descripci√≥n detallada opcional>

Closes DNT-XXX
```

**Tipos**: `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`
**Scopes**: `setup`, `api`, `ui`, `editor`, `validation`, `database`, `test`, `docs`

## üîó Integraci√≥n con Motor de Clustering

### API Endpoints Principales
```
GET    /api/presets              # Listar presets disponibles
POST   /api/presets              # Crear nuevo preset
GET    /api/presets/:id          # Obtener preset espec√≠fico
PUT    /api/presets/:id          # Actualizar preset
DELETE /api/presets/:id          # Eliminar preset

POST   /api/clusters/validate    # Validar par√°metros
POST   /api/clusters/execute     # Ejecutar clustering
GET    /api/clusters/results/:id # Obtener resultados

GET    /api/parameters/schema    # Obtener esquema de par√°metros
GET    /api/parameters/defaults  # Obtener valores por defecto
```

### Estructura de Datos
```typescript
interface ClusterParams {
  // Par√°metros b√°sicos
  min_cluster_size: number;
  min_samples: number;
  metric: 'euclidean' | 'manhattan' | 'cosine';
  cluster_selection_epsilon: number;
  
  // Par√°metros avanzados
  hierarchical_grouping?: boolean;
  max_inter_cluster_distance?: number;
  balanced_clustering?: boolean;
  
  // Post-procesamiento
  post_processing?: {
    enabled: boolean;
    min_cluster_size: number;
    max_cluster_size: number;
    target_clusters: number;
  };
}

interface ClusterResult {
  cluster_id: string;
  parameters: ClusterParams;
  results: {
    clusters: Array<{
      id: number;
      size: number;
      centroid: number[];
      samples: string[];
    }>;
    outliers: string[];
    metrics: {
      silhouette_score: number;
      calinski_harabasz_score: number;
      davies_bouldin_score: number;
    };
  };
  execution_time: number;
  created_at: string;
}
```

## üìö Ejemplos de Uso

### Crear Componente de Formulario
```typescript
// src/components/forms/ClusterForm.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { clusterParamsSchema } from '@/lib/validation';

export function ClusterForm() {
  const form = useForm({
    resolver: zodResolver(clusterParamsSchema),
    defaultValues: {
      min_cluster_size: 6,
      min_samples: 2,
      metric: 'euclidean'
    }
  });

  return (
    <form onSubmit={form.handleSubmit(onSubmit)}>
      {/* Form fields */}
    </form>
  );
}
```

### Crear Custom Hook
```typescript
// src/hooks/useClusterParams.ts
export function useClusterParams() {
  const [params, setParams] = useState(defaultParams);
  const [isValidating, setIsValidating] = useState(false);

  const validateParams = useCallback(async (newParams) => {
    setIsValidating(true);
    try {
      const response = await fetch('/api/clusters/validate', {
        method: 'POST',
        body: JSON.stringify(newParams)
      });
      const result = await response.json();
      return result;
    } finally {
      setIsValidating(false);
    }
  }, []);

  return { params, setParams, validateParams, isValidating };
}
```

### Crear API Route
```typescript
// src/app/api/clusters/validate/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { clusterParamsSchema } from '@/lib/validation';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const validParams = clusterParamsSchema.parse(body);
    
    // Validaci√≥n adicional de negocio
    const validationResult = await validateClusteringParams(validParams);
    
    return NextResponse.json({
      success: true,
      valid: validationResult.isValid,
      errors: validationResult.errors,
      warnings: validationResult.warnings
    });
  } catch (error) {
    return NextResponse.json({
      success: false,
      error: {
        code: 'VALIDATION_ERROR',
        message: error.message
      }
    }, { status: 400 });
  }
}
```

## üéØ Patrones de Desarrollo Espec√≠ficos

### Editor de Par√°metros Modular
```typescript
// Patr√≥n compound component para flexibilidad
<ParameterEditor>
  <ParameterEditor.Header title="Clustering Parameters" />
  <ParameterEditor.Body>
    <ParameterGroup name="Core Parameters">
      <ParameterInput name="min_cluster_size" />
      <ParameterInput name="min_samples" />
    </ParameterGroup>
    <ParameterGroup name="Advanced Parameters">
      <ParameterInput name="hierarchical_grouping" />
      <ParameterInput name="max_inter_cluster_distance" />
    </ParameterGroup>
  </ParameterEditor.Body>
  <ParameterEditor.Footer>
    <Button variant="primary">Apply Parameters</Button>
  </ParameterEditor.Footer>
</ParameterEditor>
```

### Validaci√≥n en Tiempo Real
```typescript
// Hook para validaci√≥n en tiempo real
function useRealtimeValidation(schema, data) {
  const [errors, setErrors] = useState({});
  
  useEffect(() => {
    const timeoutId = setTimeout(() => {
      try {
        schema.parse(data);
        setErrors({});
      } catch (error) {
        setErrors(error.flatten().fieldErrors);
      }
    }, 300); // Debounce de 300ms
    
    return () => clearTimeout(timeoutId);
  }, [data, schema]);
  
  return { errors, isValid: Object.keys(errors).length === 0 };
}
```

## üìñ Referencias y Documentaci√≥n

### Documentaci√≥n del Proyecto
- [README principal](./README.md) - Informaci√≥n general y setup
- [Arquitectura](./docs/architecture.md) - Arquitectura detallada
- [Gu√≠a de contribuci√≥n](./docs/contributing.md) - C√≥mo contribuir
- [API Reference](./docs/api.md) - Documentaci√≥n de API
- [Deployment](./docs/deployment.md) - Gu√≠a de deployment

### Referencias Externas
- [Next.js Documentation](https://nextjs.org/docs)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)
- [Tailwind CSS](https://tailwindcss.com/docs)
- [Zod Documentation](https://zod.dev/)
- [HDBSCAN Algorithm](https://hdbscan.readthedocs.io/)

### Configuraci√≥n HDBSCAN
- Ver `config.example.yaml` para configuraci√≥n completa de par√°metros
- Documentaci√≥n de par√°metros en [docs/api.md](./docs/api.md)

---

## üö® Reglas Importantes para Cursor

1. **Siempre usar TypeScript**: Todo c√≥digo debe estar tipado
2. **Validaci√≥n obligatoria**: Usar Zod para toda validaci√≥n de datos
3. **Componentes modulares**: Preferir compound components y custom hooks
4. **Performance first**: Usar memoizaci√≥n y code splitting cuando sea necesario
5. **Testing obligatorio**: Todo c√≥digo nuevo debe tener tests
6. **Documentaci√≥n**: Documentar funciones complejas y APIs
7. **Convenciones de naming**: Seguir las convenciones establecidas
8. **Git flow**: Usar branches feature/DNT-XXX para todo desarrollo
9. **Commits sem√°nticos**: Seguir conventional commits
10. **Seguridad**: Validar y sanitizar toda entrada de usuario

Este archivo `.cursorrules` debe ser la referencia principal para el desarrollo del proyecto. Mantenerlo actualizado con cambios en arquitectura y decisiones t√©cnicas.
